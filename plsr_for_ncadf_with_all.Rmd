---
title: "PLSR for N, C, and ADF with all data"
author: "Jayan Wijesingha"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(data.table)
library(dplyr)
library(hsdar)
library(ggplot2)
library(caret)
library(purrr)
library(readr)
library(ppls)
library(tibble)
library(MASS)
```

```{r read data, include=FALSE, warning=FALSE, error=FALSE, message = FALSE}

# Reading data tables

## Read WIZ data

wiz_df <- read.csv("./output_wiz/hs_all_nrm_df_wiz.csv", header = TRUE)
wiz_df$source <- rep("Witzenhausen", dim(wiz_df)[1])

## Read Rhön data

dsb_df <- read.csv("./output_dsb/hs_all_nrm_df_dsb.csv", header = TRUE)
dsb_df$source <- rep("Rhön", dim(dsb_df)[1])

## merging two data sets

all_df <- rbind(wiz_df, dsb_df)
```

# 1. Splitting data

```{r prep data, echo=FALSE, include=TRUE, warning=FALSE, error=FALSE, message = FALSE, comment=" "}

set.seed(777)

table(all_df$field_id) # Check exisisting data rows based on field id

## Separate data set in to two groups with same propotion from each group (60%)
split_sample <- groupdata2::partition(all_df, p = 0.8, cat_col = "field_id", 
                                      num_col = NULL, id_col = NULL, 
                                      id_aggregation_fn = sum, 
                                      force_equal = FALSE, list_out = F)

## Subset to train data (1)
train_df <- split_sample %>% dplyr::filter(.partitions == 1) %>% data.frame()
table(train_df$field_id)

## Subset to train data (2)
test_df <- split_sample %>% dplyr::filter(.partitions == 2) %>% data.frame()
table(test_df$field_id)

## Coulmn index for estimators (independent variables)
estimators <- c(5:122)

## Coulmn index for each targets (dependent variables)
targetN <- 130
targetADF <- 133
```

# 2. Model calibration (training)

```{r calibration, echo=FALSE, include=TRUE, warning=FALSE, error=FALSE, message = FALSE, fig.align='center', out.width="100%", comment=" "}
# 3. Model calibration (training)

## Preperation for parallel processing

library(doParallel)
cls = makeCluster(detectCores()-1) 
registerDoParallel(cls)

## Define control parameters
myControl <- trainControl(method="repeatedcv", 
                        number=10, 
                        repeats=5,
                        returnResamp = "all",
                        allowParallel = TRUE)

set.seed(777)

## 3.1 PLSR
metric <- "RMSE"
tunegrid <- expand.grid(.ncomp=c(1:12))

### PLS for N
pls_all_n <- train(n ~., data = train_df[, c(targetN, estimators)], 
                   method = "pls", metric = metric, 
                   tuneGrid = tunegrid, 
                   trControl=myControl, 
                   preProcess = c("center", "scale"))


### PLS for ADF
pls_all_adf <- train(adf ~., data = train_df[, c(targetADF, estimators)], 
                   method = "pls", metric = metric, 
                   tuneGrid = tunegrid, 
                   trControl=myControl, 
                   preProcess = c("center", "scale"))


### Visulaise calibrated models

plot(pls_all_n, main = "N (%) estimation model with PLS")
plot(varImp(pls_all_n), 10, main = "N (%) estimation model with PLS")
plot(pls_all_adf, main = "ADF (%) estimation model with PLS")
plot(varImp(pls_all_adf), 10, main = "ADF (%) estimation model with PLS")


pls_all_compare <- resamples(list("N_PLS" = pls_all_n,
                                  "ADF_PLS" = pls_all_adf))
#summary(pls_all_compare)

bwplot(pls_all_compare, scales=list(tck=c(1,0), x=list(cex=1.5), y=list(cex=1.5)))
```

# 3. Model validation (testing)

```{r validation, echo=FALSE, include=TRUE, warning=FALSE, error=FALSE, message = FALSE, fig.align='center', out.width="100%", comment=" "}
source("./obs_pred_plot.R")

obs_pred_plot(pls_all_n, test_df, 
              estimators, targetN, plot = TRUE, 
              title = "N (%) estimation model with PLS")


obs_pred_plot(pls_all_adf, test_df, 
              estimators, targetADF, plot = TRUE, 
              title = "ADF (%) estimation model with PLS")
```